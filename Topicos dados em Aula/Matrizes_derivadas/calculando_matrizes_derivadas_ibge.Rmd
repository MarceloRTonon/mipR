---
title: "Calculando as matrizes derivadas"
author: "Marcelo Tonon e Felipe Cornelio"
date: "16/07/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(include = TRUE, eval = TRUE, warning = FALSE, message = FALSE)
```

O objetivo desse texto é calcular as tabelas derivadas a partir das matrizes básicas. Faremos isso tudo usando o R. Aqui se pressupõe que os conhecimentos passados nos Tópicos 0, 1, 2 e 3 das monitorias de R foram absorvidos. Além disso, os seguintes pacotes devem estar instalados no R^[Use ```install.packages("nomedopacote")``` para instalar os pacotes.].

```{r message=FALSE, warning=FALSE}
library(readxl)
library(tidyverse)
```


Vamos usar como referência a material do [IBGE(2018)](https://biblioteca.ibge.gov.br/visualizacao/livros/liv101604.pdf). Muitas partes aqui são inclusive transcrições integrais de lá. Vamos também usar o arquivo^[ [Clique aqui](ftp://ftp.ibge.gov.br/Contas_Nacionais/Matriz_de_Insumo_Produto/2015/Matriz_de_Insumo_Produto_2015_Nivel_67.xls) para baixar o arquivo fora do R.] de Excel para a [Matriz Insumo Produto de 2015](https://www.ibge.gov.br/estatisticas/economicas/contas-nacionais/9085-matriz-de-insumo-produto.html).
 
## Baixando o arquivo pelo R.

Primeiramente iremos baixar o arquivo pelo R. Se você enfrentar problemas com este passo^[O que muito provavelmente por conta do sistema operacional que você esteja usando. Em especifico, a parte abaixo do código foi feita pensando em quem tem Windows.], baixe o arquivo manualmente e coloque ele no diretório de trabalho faça e associe ele ao objeto `arquivo_2015`.

```{r download}
#download.file("ftp://ftp.ibge.gov.br/Contas_Nacionais/Matriz_de_Insumo_Produto/2015/Matriz_de_Insumo_Produto_2015_Nivel_67.xls", destfile = "Matriz_de_Insumo_Produto_2015_Nivel_67.xls", mode = "wb")

arquivo_2015 <- "Matriz_de_Insumo_Produto_2015_Nivel_67.xls"
```

Vamos estabelecer também os nomes para os vetores de produto, de atividade e de demanda final:

```{r}
atividades <- read_excel(arquivo_2015, sheet = 1, "H4:BV4", col_names = FALSE) %>%
        as.character() 

produtos <- read_excel(arquivo_2015, sheet = 1, "B64:B132", col_names = FALSE) %>%
        as.character()

demanda_final <- read_excel(arquivo_2015, sheet = 3, "BT4:BY4", col_names = FALSE)%>%
        as.character()
```


Nas abas deste arquivo estão dispostas todas as tabelas necessários para o cálculo de uma matriz de coeficiente técnicos e de uma inversa de Leontief. Mas antes de ler propriamente os dados, vamos dar uma rápida passada sobre a estrutura da matriz.

## Tabelas do Arquivo

O arquivo `.xls` que acabamos de baixar, contém 15 abas. As abas de 1 a 10 são as ditas tabelas básicas, e da 11 à 15 temos as tabelas derivadas. Conforme o nome sugere, as cinco últimas tabelas derivam do conjunto de informações básicas expostas nas primeiras tabelas.

O conjunto de Tabelas são:

 - Tabela 01 - Recursos de bens e serviços 
 - Tabela 02 - Usos de bens e serviços 
 - Tabela 03 - Oferta e demanda da produção nacional a preço básico 
 - Tabela 04 - Oferta e demanda de produtos importados a preço básico 
 - Tabela 05 - Destino dos impostos sobre produtos nacionais 
 - Tabela 06 - Destino dos impostos sobre produtos importados 
 - Tabela 07 - Destino da margem de comércio sobre produtos nacionais 
 - Tabela 08 - Destino da margem de comércio sobre produtos importados 
 - Tabela 09 - Destino da margem de transporte sobre produtos nacionais 
 - Tabela 10 - Destino da margem de transporte sobre produtos importados 
 - Tabela 11 - Matriz dos coeficientes técnicos dos insumos nacionais - Matriz Bn 
 - Tabela 12 - Matriz dos coeficientes técnicos dos insumos importados - Matriz Bm 
 - Tabela 13 - Matriz de participação setorial na produção dos produtos nacionais - Matriz D - Market Share 
 - Tabela 14 - Matriz dos coeficientes técnicos intersetoriais - Matriz D.Bn 
 - Tabela 15 - Matriz de impacto intersetorial - Matriz de Leontief 

No arquivo de excel, as abas de cada Tabela está nomeada de acordo com o seu número, de modo que a aba da Tabela 1 se chama `"1"`. Para fazer a derivação das tabelas 11-15 nós iremos precisar apenas das Tabelas 1,2,3 e 4.

Para entendermos a composição das infromações das Tabelas de Recursos e Usos, vejamos o Quadro 1 (IBGE, 2018) abaixo:

#### Quadro 1 -  Composição das informações das Tabelas de Recursos e Usos - TRU
|                         | Produtos<br>Nacionais | Atividades | Demanda<br>Final | Valor da <br>Produção |
|:------------------------|:---------------------:|:----------:|:--------------------:|:-------------------------:|
| Produtos Nacionais      |                       | $U_n$      | $F_n$                | $q$                       |
| Produtos Importados     |                           | $U_m$      | $F_m$                |                           |
| Atividades              | $V$                       |            | $E$                  | $g$                       |
| Impostos                |                           | $T_P$      | $T_E$                |                           |
| Valor Adicionado Bruto  |                           | $y'$       |                      |                           |
| Valor Bruto da Produção | $q'$                      | $g'$       |                      |                           |
**Fonte:** IBGE(2018, p. 13)  

As informações do Quadro 1 acima podem ser explicados e importados ao R pela seguinte forma:

 - $V$ Matriz de Produção - apresenta para cada atividade o valor bruto da produção de cada um dos produtos. Pode ser encontrada na Tabela 1, entre `H6:BV132`.
 
```{r}
V <- read_excel(arquivo_2015, sheet =1, range = "H6:BV132", col_names = atividades)
```

 - $U_n$ - Matriz de Consumo Intermediário Nacional - apresenta para cada atividade o valor consumido de produtos de origem interna; Pode ser encontrada na Tabela 3, entre `D6:BR132`.

```{r}
U_n <- read_excel(arquivo_2015, sheet =3, range = "D6:BR132", col_names = atividades)
```

 - $U_m$  -  matriz  de  consumo  intermediário  importado  -  apresenta  para  cada  atividade  o  valor  consumido  de  produtos  de  origem externa; Pode ser encontrada na Tabela 4, entre `D6:BR132`.

```{r}
U_m <- read_excel(arquivo_2015, sheet =4, range = "D6:BR132", col_names = atividades)
```
 - $F_n$ - matriz da demanda final por produtos nacionais - apresenta o valor consumido de produtos de origem interna por categoria da demanda final (consumo final do governo, consumo final das Instituições sem fins de lucro a serviço das famílias, consumo final das famílias, exportações, formação bruta de capital fixo e variação de estoques); Pode ser encontrada na Tabela 3, entre `BT6:BY132`.

```{r}
F_n <- read_excel(arquivo_2015, sheet =3, range = "BT6:BY132", col_names = demanda_final)
```


 - $F_m$ - matriz da demanda final por produtos importados - apresenta o valor dos produtos de origem externa consumidos pelas categorias da demanda final. Pode ser encontrada na Tabela 4, entre `BT6:BY132`.

```{r}
F_m <- read_excel(arquivo_2015, sheet =4, range = "BT6:BY132", col_names = demanda_final)
```


 - $q$ - vetor com o valor bruto da produção total por produto. Pode ser calculado a partir de $q = Vi$ ou $q = U_ni + F_ni$.

```{r}
q <- V %>% rowSums()

#Ou

# q2 <- rowSums(U_n) + rowSums(F_n)
```


 - $E$ - matriz da demanda final por atividade - representa a parcela do valor bruto da produção de uma atividade destinada à demanda final. Pode ser calculando usando a $F_n$ (ou $F_M$) e a Matriz de Market Share (falaremos desta mais a frente).

 - $T_p$ - matriz dos valores dos impostos e subsídios associados a produtos, incidentes sobre bens e serviços absorvidos (insumos) pelas atividades produtivas. Pode ser encontrada na Tabela 5, entre `D6:BR132`.
 
```{r}
T_p <- read_excel(arquivo_2015, sheet = 5, range = "D6:BR132", col_names = atividades)
```
 

 - $T_e$  -  matriz  dos  valores  dos  impostos  e  subsídios  associados  a  produtos,  incidentes  sobre  bens  e  serviços  absorvidos  pela demanda final. Pode ser encontrada na Tabela 4, entre `BT6:BY132`.

```{r}
T_e <- read_excel(arquivo_2015, sheet = 5, range = "BT6:BY132", col_names = demanda_final)
```


 - $g$ - vetor coluna com o valor bruto da produção total por atividade. Pode ser calculada a partir de $g = V'i$

```{r}
g <- colSums(V)
```

 - $y$  -  vetor  coluna  com  o  valor  adicionado  total  gerado  pelas  atividades  produtivas  -  é  considerado  como  um  vetor  por  medida de simplificação, na prática é uma matriz por atividade com o valor adicionado bruto a preços básicos, as remu-nerações (salários e contribuições sociais), o excedente bruto operacional (obtido por saldo) e os impostos e subsídios incidentes sobre as atividades. Esses valores podem ser encontrados nas Tabelas de Recursos e Usos do IBGE^[porém podem também ser calculados a partir das matrizes derivadas.]

Além dessas presentes na tabela, podemos também já calcular os vetores $f_n = F_ni$ e $f_m=F_mi$

```{r}
f_n <- rowSums(F_n)

f_m <- rowSums(F_m)
```


## Tabelas Derivadas

Com as matrizes importadas, podemos então calcular as seguintes tabelas derivadas



 - $B_n$ - Matriz dos coeficientes técnicos dos insumos nacionais (Tabela 11) 
 
 - $B_m$ - Matriz dos coeficientes técnicos dos insumos importados (Tabela 12)
 
 - $D$ - Matriz de participação setorial na produção dos produtos nacionais - Market Share (Tabela 13)

 - $A_n$ - Matriz dos coeficientes técnicos intersetoriais nacionais (Tabela 14)

 - $L$ - Matriz de impacto intersetorial - Matriz de Leontief (Tabela 14)

Além das cinco matrizes derivadas que podem ser encontradas no arquivo baixado, podemos também estimar as duas matrizes abaixo:

 - $A_m$ - Matriz dos coeficientes técnicos intersetoriais importados

 - $A_{Tot}$ - Matriz dos coeficientes técnicos intersetoriais totais

 - $E$ - Vetores de Demanda Final a nível de atividad

#### Calculando $B_n$ e $B_m$

Para calcularmos as matrizes de coeficientes técnicos dos insumos nacionais e dos importados, fazemos:

\begin{align}
B_n &= U_n (\hat{q}^{-1}) \\
B_m &= U_m (\hat{q}^{-1})
\end{align}



```{r}
B_n <- U_n %>% as.matrix %*% solve(diag(c(g)))

B_m <- U_m %>% as.matrix %*% solve(diag(c(g)))
```


#### Calculando $D$

Para calcular a Matriz de Market Share fazemos:

$$D = V' (\hat{q}^{-1})$$

```{r}
D_MS <- t(V) %*% solve(diag(c(q)))
```


#### Calculando $A_n$

Para calcular a Matriz de Coeficientes técnicos intersetorias nacionais fazemos:

$$A_n = D B_n$$

```{r}
A_n <- as.matrix(D_MS) %*% B_n
```

#### Calculando $L$

Para calcular a Matriz de Leontief fazemos

$$L = [I-A]^{-1}$$

```{r}
Lentief <- solve(diag(nrow(A_n)) - A_n)
```



#### Calculando $A_m$

Para calcular a Matriz de Coeficientes técnicos intersetorias importados fazemos:

$$A_m = D B_m$$

```{r}
A_m <- D_MS %*% as.matrix(B_m)
```

#### Calculando $A_{Tot}$

Para calcular a Matriz dos Coeficientes Técnicos Totais, $A_{Tot}$, fazemos:

$$A_{Tot} = A_n + A_m$$

```{r}
A_Tot <- A_n + A_m
```


#### Calculando $E$

Para calcular os vetores de Demanda Final à nível de Atividade, $E$, basta:

$$E = D F$$

```{r}
E_n <- D_MS %*% as.matrix(F_n)

E_n <- D_MS %*% as.matrix(F_m)
```



## Referências:

IBGE. **Matriz de insumo-produto: Brasil: 2015**. Rio de Janeiro: IBGE, Coordenação de Contas Nacionais, 2018.


# Descarte?


Para o exercício que vamos realizar aqui, vamos precisar apenas das quatro primeiras tabelas, de forma que iremos focar nas especificidades de cada uma delas. No entanto, é bem provável que o conhecimento adquirido aqui seja suficiente para vocês realizarem a leitura dos demais arquivos.

Por enquanto, vamos realizar a leitura das abas que de fato são necessárias para o exercicio. Seriam as quatro primeiras abas, com as tabelas de recursos e as tabelas de usos (doméstico e importado). 

Conforme desenvolvido na apostilado curso, uma das maiores dificuldades em se trabalhar com os arquivos baixados diretamente no IBGE é lidar com o cabeçalho. Para lidar com isso, vamos criar vetores padrões com os nomes mais fundamentais, a saber: os produtos e as atividades.

```{r}
#Lendo o arquivo que baixamos no início do tópico, vamos extrair os nomes das atividades:
arquivo_2015 <- read_excel("Matriz_de_Insumo_Produto_2015_Nivel_67.xls")

```


