---
title: "POF 2010 - Leitura"
author: "Marcelo Tonon"
date: "28/07/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Por uma questão de exemplificação iremos tratar a principio aqui da POF feita entre 2008 e 2009. Numa outra ocasião podemos passar para a POF feita entre 2017 e 2018.

Esse material usa muitas partes dos scripts feitos por Ana Camila e Pedro Gomes Andrade ao longo do Curso da POF fornecido por IPEA/ENCE/UFRJ/UFF.


## Pacotes Necessários


```{r}
library(tidyverse)
```


## Baixando os arquivos

Como os arquivos da POF são **muito pesados**, não iremos baixar ele diretamente pelo *R*, uma vez que isso seria complicado demais para quem tem uma conexão com a internet mais instável. Para baixar eles, basta ir no site do [IBGE](https://www.ibge.gov.br/estatisticas/sociais/rendimento-despesa-e-consumo/9050-pesquisa-de-orcamentos-familiares.html?=&t=downloads) de Downloads da POF, escolher a versão da pesquisa que você deseja baixar, clicar em `Microdados` e então em `Dados.zip`.

No nosso caso temos: 

`Pesquisa_de_Orçamentos_Familiares_2008_2009`
    `Microdados`
        `Dados.zip`

Um detalhe que pode ser útil a quem quiser baixar pelo `R` (para fins de automatização), para conseguir o link do download do arquivo, vá na parte de downloads do seu navegador^[Funciona para o Firefox.], clique com o botão direito do mouse sobre o arquivo baixado e depois clique em algo como: `Copiar link do Download`e você terá então o link do download^[No caso, o link do download de `Dados.zip` é: "ftp://ftp.ibge.gov.br/Orcamentos_Familiares/Pesquisa_de_Orcamentos_Familiares_2008_2009/Microdados/Dados.zip"].



Estando `Dados.zip`  baixado e localizado no Diretório de Trabalho, podemos então descompacta-lo parcialmente pelo R.

```{r, eval = FALSE}
unzip("Dados.zip")
```

Infelizmente, o responsável pela compactação dos arquivos escolheu o formato `.7z` que é bem chato para vários sistemas (algumas distribuições do Linux em especial) descompactar. O mesmo vale para o R^[Existe um pacote chamado [`archive`](https://github.com/jimhester/archive), porém ainda não foi atualizado para ser usado na versão 4.0 do R.]. Assim, a descompactação vai ter que ser feita na mão mesmo.

**Importante:** Extraia os arquivos no mesmo local do arquivo, de modo que o arquivo `T_ALUGUEL_ESTIMADO_S.txt` esteja em `Dados/T_ALUGUEL_ESTIMADO_S.txt` e não em `Dados/T_ALUGUEL_ESTIMADO_S/T_ALUGUEL_ESTIMADO_S.txt`.

Assim, vamos usar `list.files` em conjunto com `stringr::str_subset` para criar um vetor excluindo os arquivos compactados em `7z`^[Veja]:

```{r}
arquivos_dados <- list.files("Dados", full.names = T) %>%
  str_subset(".7z", negate = TRUE)
```

Como você pode perceber a POF está dividida em vários arquivos, dado o seu tamanho.

Para ler os dados da POF iremos usar a função `read.fwf`, que serve para ler arquivos de texto, cujos valores são separados pelo comprimento (*widht*) de cada variável. Assim, precisamos dos dados que especifiquem nomes das variáveis e os seus comprimentos. Para tanto serve os dicionarios fornecidos por Ana Camila e o Pedro Lourenço no curso sobre a POF. Você pode acessa-lo na pasta da [monitoria do curso](https://drive.google.com/drive/folders/1CjlDiFpr0AWC2hwv36Up4aNp1UivjGIX?usp=sharing).

Baixe a pasta `dicionarios` e coloque-a no seu diretorio de trabalho.

## Lendo os arquivos

Ler os arquivos da POF leva bastante tempo. Pois se trata de muitos arquivos e num formato não muito convidativo (`.txt`). Assim vamos usar aqui a função `read_fwf` (indicada para esse caso) e a `fwf_widths`, que controla o tamanho de cada variável. Isso ocorre pois os arquivos em `.txt` não tem um separador de colunas e células como no caso de `.csv`. Assim, precisamos avisar ao `R` qual é o comprimento das celulas de cada coluna. Além disso, os nomes das variáveis não estão de uma forma que vai nos agradar, e portanto, vamos indicar isso também.

Vamos começar lendo a base de despesas de 90 dias, disponível na POF2 - Quadro 6 a 9 - Registro 6.

Os dicionários estão em csv2, e usamos `type_convert()` para mudar os tipos de algumas colunas:
```{r}
pof2.reg6.desp.90.dias <- read.csv2("dicionarios/pof2.reg6.desp.90.dias.csv",
                                    header=TRUE) %>%
  type_convert()
```

Vamos então associar o tamanho das colunas de `pof2.reg6.desp.90.dias` com as variáveis `tamanho` e os nomes das colunas com a coluna `variavel`. Isso tudo usando a função `fwf_widhts`:

```{r}
col.pos <- fwf_widths(pof2.reg6.desp.90.dias$tamanho,
                      col_names = pof2.reg6.desp.90.dias$variavel)
```

Vamos então carregar os dados da POF. Importante notar, que vamos usar o *mesmo nome* que usamos para o dicionário, porém já pegamos as informações que queriamos e alocamos em `col.pos`:

```{r}
pof2.reg6.desp.90.dias <- read_fwf(file = "Dados/T_DESPESA_90DIAS_S.txt",
                                   col_positions = col.pos)

```

Usando `str()` no objeto percebemos que temos alguns valores em `character` que queremos como númericos.
```{r}
str(pof2.reg6.desp.90.dias)
```

Neste caso, `type_convert()` não será de muita ajuda, porém podemos usar uma função do `dplyr` chamada `mutate`^[`mutate` cria, modifica e deleta colunas.] que nos permite modificar com mais agilidade os tipos de cada coluna.

```{r}
pof2.reg6.desp.90.dias <- pof2.reg6.desp.90.dias %>%
                          dplyr::mutate(fator_exp = as.numeric(fator_exp), 
                                        fator_exp_2 = as.numeric(fator_exp_2),
                                        desp_anu_exp= as.numeric(desp_anu_exp),
                                        valor_despe = as.numeric(valor_despe))
```

Vamos então criar o código da unidade de consumo `UniConsumoID` (9 digitos) a parte da `uf` (2 digs.), `n_seq` (3 digs.), `dv_seq` (1 dig.), `n_dom` (2 digs.), `n_uc` (1 digs.):

```{r}
pof2.reg6.desp.90.dias <- pof2.reg6.desp.90.dias %>%
                          dplyr::mutate(UniConsumoID = paste0(uf, n_seq, dv_seq, n_dom, n_uc))
```

Vamos então pegar o valor das despesas anualizadas `valor_defl_anu`  e dividir pelo o fator de expansão `fator_exp_2`:

```{r}
pof2.reg6.desp.90.dias <- pof2.reg6.desp.90.dias %>%
                          dplyr::mutate(valor_defl_anu = (desp_anu_exp/fator_exp_2))
```

Vamos agora criar um código do IBGE `codeIBGE` para identificar os itens das despesas. Para tanto, vamos pegar os 3 primeiros números da coluna `cod_item` e contanetar com o número do quadro.

```{r}
pof2.reg6.desp.90.dias <- pof2.reg6.desp.90.dias %>%
                          dplyr::mutate(codeIBGE = paste0(n_quadro, substr(cod_item, 1, 3)))
```

Vamos então selecionar as variáveis de interesse dessa base de dados em especifico. No nosso exemplo, vamos selecionar o código da Unidade de Consumo `UniConsumoID`, os códigos dos produtos pelo IBGE `codeIBGE`, os fatores de expansão, `fator_exp` e `fator_exp_2` e os valores das despesas deflacionadas e anualizadas sem o fator de expansão.

```{r}
pof2.reg6.desp.90.dias <- pof2.reg6.desp.90.dias %>%
                          dplyr::select(UniConsumoID, codeIBGE, fator_exp, fator_exp_2, valor_defl_anu)
```

#### Lendo as demais bases

Vamos agora ler as demais bases de dados presentes em dados. O processo é muito similar ao que foi feito para `pof2.reg6.desp.90.dias`. O 