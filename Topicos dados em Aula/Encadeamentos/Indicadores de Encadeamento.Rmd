---
title: "Indicadores de Encadeamentos"
author: "Felipe Cornelio e Marcelo Tonon"
date: "23/08/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# 1. Introdução

Nesse material iremos apresentar diversos indicadores de encadeamentos para a economia, conforme a literatura apresentada no curso. Além dos impactos sobre os dados originais da matriz, incluiremos também o efeito induzido sobre o consumo das famílias. 

O primeiro passo é a leitura dos dados, para os quais usaremos a matriz ao nível de 67 setores divulgado para o IBGE para o ano de 2015. Vale destacar que os exercícios aqui eleborados podem ser facilmente aplicados tambéms para as matrizes estimadas para os demais anos.

## Leitura dos Dados


```{r, warning=F, }
# Pacotes
library(readxl)
library(purrr)
library(formattable)
```

Antes da leitura dos dados, mostraremos novamente a forma de fazer o download automático da matriz. Caso já tenha o arquivo no diretório e não queira refazer o download, é necessário apenas fazer a leitura do comando para o nome do arquivo:

```{r download}
#download.file("ftp://ftp.ibge.gov.br/Contas_Nacionais/Matriz_de_Insumo_Produto/2015/Matriz_de_Insumo_Produto_2015_Nivel_67.xls", destfile = "Matriz_de_Insumo_Produto_2015_Nivel_67.xls", mode = "wb")

MIP_2015 <- "Matriz_de_Insumo_Produto_2015_Nivel_67.xls"
```

Realizando agora leitura dos dados obtidos diretamente da matriz de insumo-produto do IBGE:

```{r, warning=F}

# Vetores com os nomes das atividades e dos produtos
nomes_produtos <- read_xls(MIP_2015, sheet='01', range='B6:B132',col_names = 'Prod_nome') %>% t() %>% as.character()
nomes_atividades <- read_xls(MIP_2015, sheet='13', range='B6:B72',col_names = 'Ativ_nome') %>% t() %>% as.character()

# Informações da MIP
An <- read_xls(MIP_2015, sheet = '14', range='c6:bq72', col_names = nomes_atividades)
L <-  read_xls(MIP_2015, sheet = '15', range='c6:bq72', col_names = nomes_atividades)
DF_127 <- read_xls(MIP_2015, sheet = '03', range='BT4:BY132') %>% na.omit()
MS <- read_xls(MIP_2015, sheet = '13', range='c6:dy72', col_names = nomes_produtos)
x <- as.matrix(t(read_xls(MIP_2015, sheet='01', range='H134:BV134', col_names = nomes_atividades)))

```

Além da MIP são necessárias informações da Tabela de Recursos e Usos para realizar todas as tarefas que serão apresentadas aqui. A obtenção de forma automatizada dessa parte envolveria um conhecimento que será discutido no tópico 5 das monitorias, mas ainda não apresentado.^[As TRUs são disponibilizadas pelo IBGE em um arquivo compactado (.zip ou .rar) com diversos arquivos contidos, em que necessitamos apenas das Tabelas 2, com as informações dos Usos a preços correntes.]

```{r,warning=FALSE}
# VA TRU 2015
nomes_va <- read_xls("68_tab2_2015.xls", sheet='VA', range='A6:A19',col_names = "TRU") %>% t() %>% as.character()
TRU_2015 <- read_xls("68_tab2_2015.xls", sheet='VA', range='B4:BQ19') %>% as.data.frame() %>% na.omit()
rownames(TRU_2015) <- nomes_va
# Soma do Comercio Varejo e Atacado
Comercio <- TRU_2015[,42]+TRU_2015[,43]
TRU_2015[,42] <- Comercio
TRU_2015[,43] <- NULL
```

# 2. Indicadores de Encadeamento para Trás e para Frente

A partir desses dados podemos extrair informações relevantes acerca das relações intersetoriais e os setores com maiores impactos. Em primeiro lugar, podemos extrair os indicadores de encadeamento para trás (backward linkages - bl), que indicam o impacto de uma variação na demanda final de um dado setor sobre os demais setores da economia (via demanda intermediária); e encadeamentos para frente (forward linkages - fl), indicando o quanto uma atividade é sensível a variações das demais atividades. 


## 2.1 Efeitos Diretos

O primeiro indicador é o apresentado por Chenery e Watanabe (1958), que capta os impactos diretos de um setor, sem levar em conta a difusão que esse impacto pode ter para outros setores que não estão diretamente ligados ao setor na cadeia. Ele é calculado pela soma nas colunas da matriz de coeficientes técnicos (An) em sua versão de encadeamentos para trás ($b$) e pela soma das linhas para avaliar os encadeamentos para frente ($f$). Matricialmente teríamos:
$$ b=i'A_n$$
$$f=A_ni$$
Isso poderia ser calculado no R da seguinte forma:

```{r}

# Encadeamentos diretos para trás
b <- colSums(An)

# Encadeamentos diretos para frente
f <- rowSums(An)
```


## 2.2 Efeitos Diretos e Indiretos

Mais precisamente, os encadeamentos para trás seriam obtidos pela soma dos componentes de cada coluna da matriz de impacto, enquanto os encadeamentos para frente obtidos pela soma de cada linha da matriz de impacto. Usando a notação de Miller e Blair (2009), temos que a matriz de impacto é tal que:
$$L=(I-A_n)^{-1}$$
Esta versão de indicador de encadeamentos para trás e de encadeamentos para frente é baseado em Rasmussen (1956), e seria capaz de captar tanto os efeitos diretos, quanto os efeitos indiretos - i.e. os efeitos sobre a cadeia produtiva dos setores que foram impactados diretamente na cadeia produtiva do setor estimulado. No caso, teríamos os 
backward linkages 
$$bl=i'L$$
$$fl=Li$$		
Onde i é um vetor de soma composto por números 1 e Z é uma matriz de impacto arbitrária. 

```{r}
bl <- as.data.frame(colSums(L))
names(bl) <- 'Backward Linkages'
```

```{r}
fl <- as.data.frame(rowSums(L))
names(fl) <- 'Forward Linkages'
```

Se quisermos isolar os efeitos indiretos, basta realizar a substração entre os indicadores com efeitos diretos e indiretos ($bl$ e $fl$) e o que capta somente o efeito direto ($b$ e $f$):

```{r}
bl_ind <- bl - b
```

```{r}
fl_ind <- fl - f
```


## 2.3 Síntese dos Resultados

Vamos agora reunir os resultados para os dois tipos de indicadores apresentados: i) Diretos e ii) Diretos + Indiretos.

```{r}
sintese <- data.frame(b,bl,f,fl)
names(sintese) <- c("b", "bl","f","fl")
```

Vamos então visualizar os resultados e quais são os setores-chave da economia de acordo com cada indicador:

```{r}

formattable(sintese, list(
  b = formatter("span", style = x ~ style(color = ifelse(rank(-x) <= 5, "darkgreen", "gray")), x ~ sprintf("%.2f (R: %02g)", x, rank(-x))), 
  bl = formatter("span", style = x ~ style(color = ifelse(rank(-x) <= 5, "darkgreen", "gray")), x ~ sprintf("%.2f (R: %02g)", x, rank(-x))),
  f = formatter("span", style = x ~ style(color = ifelse(rank(-x) <= 5, "darkgreen", "gray")), x ~ sprintf("%.2f (R: %02g)", x, rank(-x))), 
  fl = formatter("span", style = x ~ style(color = ifelse(rank(-x) <= 5, "darkgreen", "gray")), x ~ sprintf("%.2f (R: %02g)", x, rank(-x))))) %>% as.datatable()

```

# 3. Indicadores Normalizados

Conforme Nassif, Teixeira e Rocha (2015), Freitas e Dweck (2010) e Miller e Blair (2009), uma melhor forma de entender quão relevante é um setor para a economia é calcular os índices de poder de dispersão e sensibilidade de dispersão. Mas antes disso, necessita-se de duas medidas que indicam o impacto e a sensibilidade média de cada atividade. O primeiro são os backward e forward linkages médios, ou seja, os componentes do vetor bl e fl divididos pelo escalar (m) representando o número total de atividades (soma do número de atividades/setores:
$$\bar{bl}=bl(1/m)$$
$$\bar{fl}=fl(1/m)$$
A segunda medida necessária é a média total dos coeficientes da matriz de impacto, de forma a normalizar os encadeamentos médios. Os valores são obtidos mediante a soma de todos os coeficientes da Matriz de Impacto, divididos pelo número de atividades ao quadrado:
$$M_{tot}=i'Li(1/m^2)$$		
Em posse de ambas as medidas, os indicadores de poder de dispersão (pd) sensibilidade de dispersão (sd) de forma que:
$$pd=\bar{bl}/M_{tot}$$
$$sd=\bar{fl}/M_{tot}$$
Trata-se de uma medida normalizada de impacto, de forma a avaliar comparativamente os setores, e não para se obter uma medida absoluta de impacto. Para o poder de dispersão, valores maiores do que a unidade (bl>1) representam setores chave que apresentam impacto sobre os demais setores superior ao impacto médio total e vice-versa. Já para a sensibilidade de dispersão, valores maiores que a unidade (sd>1) representam setores que respondem a variações em outros setores em uma magnitude maior que a média da economia, e vice-versa.

No R, estes indicadores são facilmente obtidos:
```{r}
# Indicadores de Poder e Sensibilidade de Dispersão

bl_medio <- bl/67
fl_medio <- fl/67
M_tot <- as.data.frame(sum(L)/(67^2))

pd <- bl_medio/as.numeric(M_tot)
sd <- fl_medio/as.numeric(M_tot)

```

Criando uma tabela reunindo os valores e ordenando os setores:

```{r}
#reunindo os dados
sintese_norm <- data.frame(pd,sd)
names(sintese_norm) <- c("pd", "sd")

# Gerando a tabela
formattable(sintese_norm,list(
  pd = formatter("span", style = x ~ style(color = ifelse(rank(-x) <= 5, "darkgreen", "gray")), x ~ sprintf("%.2f (R: %02g)", x, rank(-x))), 
  sd = formatter("span", style = x ~ style(color = ifelse(rank(-x) <= 5, "darkgreen", "gray")), x ~ sprintf("%.2f (R: %02g)", x, rank(-x)))))  %>% as.datatable()

```


# 4. Outros métodos

Apresentaremos aqui dois indicadores um pouco mais complexos que os já discutidos. O primeiro será o método de extração hipotética e ou outro será o do autovetor (eigenvector).

## 4.1 Extração Hipotética

O método da extração hipotética avaliar os impactos sobre a economia caso você retire, hipoteticamente, algum setor.^[Vale destacar que um exercício alternativo para avaliar este impacto seria substituir produção doméstica por importações, o que equivaleria à zerar a oferta intermediária desse bem na matriz de coeficientes técnicos e no vetor da demanda final.] Isso pode ser realizado ao excluir a linhas e colunas de algum setor i e também a linha deste setor na demanda final, para então calcular qual o valor da produção dessa matriz reduzida. O Total Linkages (TL) mede então a diferenção entre o valor da produção da matriz completa ($x$) e o valor da produção da matriz reduzida ($x_l^{-i}$):

$$ TL = i'x - i'x_l^{-i} $$

```{r}
  TL <- data.frame(c(1:nrow(An)), row.names = nomes_atividades)
  names(TL) <- "TL"

for (i in 1:nrow(An)){
  An_aux <- An[,-i] 
  An_aux <- An_aux[-i,]
  f <- as.matrix(MS)%*%rowSums(DF_127) %>% as.data.frame()
  f_aux <- f[-i,]
  TL[i,] <- sum(x) - sum(solve(diag(1,nrow(An_aux))-as.matrix(An_aux))%*%as.matrix(f_aux))
}


```


```{r}
# Gerando a tabela
formattable(TL,list(
  TL = formatter("span", style = x ~ style(color = ifelse(rank(-x) <= 5, "darkgreen", "gray")), x ~ sprintf("%.2f (R: %02g)", x, rank(-x)))))  %>% as.datatable()

```

## 4.2 Eigenvector

Por fim, uma outra alternativa para medir os encadeamentos da economia é o metodo do Autovetor (Eigenvector), conforme visto em alguns trabalhos como Dietzenbacher (2002), Luo (2013) e Morrone (2017). Trata-se de uma medida que realiza iterações sucessivas entre algum indicador de encadeamento e a respectiva matriz de coeficientes técnicos. Conforme Luo (2013), a medida normalizada para a primeira iteração é dada por:
$$ r_{i+1} = nr'_iA/r'_iAe $$
Com $r_i$ sendo um indicador de backward linkages e $n$ o número total de setores. A maior contribuição de Dietzenbacher (1992) é mostrar que, ao fazer as interações tenderem ao infinito, o resultado para indicador equivale aos elementos da seguinte relação, também chamados de Power of Pull (PoP):
$$PoP=nq'/(q'e)$$

Onde $q'$ é autovetor dominante da esquerda ou vetor de Perron (left-hand eigenvector) da matriz de coeficientes e resultante de $q'A=q'\lambda$, $n$ é o número de setores e $e$ é um vetor de soma. O right-hand eigenvector é o cálculo de autovalor e autovetor mais comum e pode ser obtido em uma equação caracteristica da forma $Av=\lambda v$. Já o left-hand eigenvector tem como definição uma equação da forma $uA=\kappa u$,mas que equivale também à calcular os autovalores e autovetores na forma convencional sobre a matriz transposta: $A'u'=\kappa u'$. O primeiro passo é calcularmos os autovalores e autovetores da nossa matriz de coeficientes técnicos transposta, tal que:

```{r}
# Calculando os autovalores e autovetores sobre a matriz An transposta:
eigen_An <- eigen(t(An))
lambda <- eigen_An$values[1] %>% as.matrix()
q_dom <- t(eigen_An$vectors[,1]) %>% as.matrix()

# Testando se a definição é atendida
all.equal(q_dom%*%as.matrix(An), lambda%*%q_dom, check.attributes=F)

```

A função `eigen()` retorna tanto os autovalores quanto os autovetores de uma matriz ordenando-os do maior para o menor. O passo seguinte é calcular o $PoP=nq'/(q'e)$

```{r}
PoP <- t((67*q_dom)/sum(q_dom)) %>% as.numeric() %>% as.data.frame()
row.names(PoP) <- nomes_atividades
names(PoP) <- "PoP"
```

Antes de prosseguir, iremos replicar a tabela 1 de Morrone (2017), mas antes devemos criar os indicadores ponderados de encadeamentos diretos (que é uma variação do indicador que vimos iniciamente de Chenery e Watanabe) e também o de efeitos diretos e indiretos (Rasmussen), ambos em sua versão de backward linkages. Perceba também que a representação abaixo é equivalente ao cálculo dos indicadores de poder de dispersão discutidos na seção anterior:
$$m=ni'A_n/i'A_ni$$
$$z=ni'(I-A_n)/i'(I-A_n )i$$
```{r}
m <- (67*colSums(An))/(sum(An))
  
z <- (67*colSums(L))/(sum(L))
```


Unindo os resultados em um data.frame, a comparação dos resultados é tal que:


```{r}
# Unindo os dados
Indicadores <- data.frame(m, z, PoP)
names(Indicadores) <- c("C_W", "Rasmussen", "Eigenvector")

# Gerando a tabela
formattable(Indicadores,list(
  C_W = formatter("span", style = x ~ style(color = ifelse(rank(-x) <= 5, "darkgreen", "gray")), x ~ sprintf("%.2f (R: %02g)", x, rank(-x))),
  Rasmussen = formatter("span", style = x ~ style(color = ifelse(rank(-x) <= 5, "darkgreen", "gray")), x ~ sprintf("%.2f (R: %02g)", x, rank(-x))),
  Eigenvector = formatter("span", style = x ~ style(color = ifelse(rank(-x) <= 5, "darkgreen", "gray")), x ~ sprintf("%.2f (R: %02g)", x, rank(-x)))))  %>% as.datatable()

```

# 5. Referências

CHENERY, H.B. and WATANABE, T. (1958): *International Comparisons of the Structure of Production**. Econometrica, 26, 487–521.

FREITAS, F. E DWECK, E. (2010): *Matriz de Absorção de Investimento e Análise de Impactos Econômicos, Relatório Final Estudo Transversal: Projeto Perspectivas de Investimento no Brasil*, Rio de Janeiro

MILLER, R.E.; BLAIR, E. (2009): **Input-Output Analysis: Foundations and Extensions**. Second Edition. Cambridge: Cambridge University Press.

MORRONE, E. (2017): **Which sectors to stimulate first in Brazil? Estimating the sectoral power to pull the economy out of the recession*. Investigación Económica, v.76, n.302.

NASSIF, TEIXEIRA e ROCHA (2015): **Houve redução do impacto da indústria na economia brasileira no período 1996-2009? Uma análise das matrizes insumo-produto*. Economia e Sociedade, Campinas, v. 24, n. 2 (54), p. 355-378.

RASMUSSEN, N.P. (1956): *Studies in Intersectoral Relation*. North-Holland, Amsterdam.
