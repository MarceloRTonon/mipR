---
title: "Tópico 6 - Visualizando resultados de Decomposições Estruturais no ggplot2"
author: "Marcelo Tonon e Felipe Cornelio"
date: "29/09/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(eval = T, include = TRUE, warning = F)
# Todos os chunks em que estiver escrito "MT" quer dizer = Mensagem do Tonon. É um quadro dando dicas e etc... Use r = Mensagem do Felipe.
```

```{r MTcronograma_tonon, eval = F, include=F}

# O que eu penso em fazer para este topico é fazer uma decomposição aditiva, uma multiplicativa e uma com a decomposição da matriz de leontief. Vou repetir o exemplo do Dietzenbacher, Lahr e Los (2004) para 2010-2015 só que também focando na aditiva. Assim os passos serão:

# 1- Baixar os arquivos (pois é o primeiro)
# 2- Int
```

## Pacotes Necessários

```{r, warning=FALSE}
library(ggplot2)
library(readxl)
library(purrr)
library(stringr)
```


## Objetivos do Tópico

Esse tópico irá introduzir tanto o tema de análise de decomposição estrutural quanto introduzir o uso do pacote `ggplot2` para a criação de gráficos. 

Para a parte de decomposição estrutural, a bibliografia utilizada será o capítulo 13 do livro de Miller e Blair (2009), bem como os artigos de Dietzenbacher e Los (1998) e Dietzenbacher, Lahr e Los (2004).

Para a parte de criação de gráficos com o `ggplot2` a bibliografia utilizada será o 

**Importante:** Ambos os temas são de tal profundidade que este material não poderia nem presumir esgotar ambos os tópicos.

## Dados Necessários

Para realizar uma decomposição estrutural é necessário que as bases sejam compatíveis na sua estrutura em termos de linhas e colunas. No nosso caso, nós iremos comparar as bases de 2010 e 2015 com 12 setores cada uma.

Criando arquivos temporários^[A vantagem de arquivos temporários é que eles não ficam permanentemente gravados no seu disco rígido. Para arquivos pequenos como os que estamos tratando, é bastante vantajoso.] para servirem de parâmetros em `destfile`:

```{r}
mip2010 <- tempfile(fileext = ".xls")
mip2015 <- tempfile(fileext = ".xls")
tbru <- tempfile(fileext = ".zip")
```

Definindo os links a serem baixados:^[Importante: Para diminuir a poluição visual na hora da leitura, este arquivo está configurado para ignorar os `warnings` dados pelo R. Assim, ao reproduzir esta e outras partes deste tópico você pode se deparar com `warnings` referentes a esta questão. A exceção é a função `read_xls` que sempre avisa quando cria novos nomes.]

```{r}
link_2010 <- "ftp://ftp.ibge.gov.br/Contas_Nacionais/Matriz_de_Insumo_Produto/2010/Matriz_de_Insumo_Produto_2010_Nivel_12_20161019.xls"

link_2015 <- "ftp://ftp.ibge.gov.br/Contas_Nacionais/Matriz_de_Insumo_Produto/2015/Matriz_de_Insumo_Produto_2015_Nivel_12.xls"

link_tbru <- "ftp://ftp.ibge.gov.br/Contas_Nacionais/Sistema_de_Contas_Nacionais/2015/tabelas_xls/tabelas_de_recursos_e_usos/nivel_12_2000_2015_xls.zip"
```

Baixando os arquivos sendo os arquivos temporários os arquivos destino:

```{r}
download.file(url = link_2010, destfile = mip2010, mode = "wb")
download.file(url = link_2015, destfile = mip2015, mode = "wb")
download.file(url = link_tbru, destfile = tbru, mode = "wb")
```

Vamos ler com `readxl::read_xls` as partes que nos interessam dos arquivos de matriz insumo produto baixados. Vejamos a relação destes abaixo:

| **Nome do objeto** | **Descrição**                                               | **Aba** | **range**  |
|--------|---------------------------------------------------------|-----|--------|
| `nomesSetores`  | Nomes dos Setores                                       | 01  | <span style="color: green;"> "B6:B17" </span> |
| `Bn`     | Matriz dos Coeficientes Técnicos dos Insumos Nacionais  | 11  | <span style="color: green;"> "C6:N17" </span> |
| `Bm`     | Matriz dos Coeficientes Técnicos dos Insumos Importados | 12  | <span style="color: green;"> "C6:N17" </span> |
| `D_MS`   | Matriz de Market Share                                  | 13  | <span style="color: green;"> "C6:N17" </span> |
| `f_p`    | Demanda final ao nivel do produto                       | 03  | <span style="color: green;"> "V6:V17" </span> |

Vamos primeiro carregar os nomes dos setores:

```{r}
nomesSetores <- read_xls(mip2010, sheet = "01", range = "B6:B17", col_names = "Setores")

```

Vamos criar agora listas com os parâmetros de cada elemento:

```{r}
mipElements <- list("Bn", "Bm", "D_MS", "f_p")


nomesSetores <- list(nomesSetores$Setores, 
                     nomesSetores$Setores,
                     nomesSetores$Setores,
                     "Total") %>%
  setNames(mipElements)

mipRanges <- list("C6:N17", "C6:N17", "C6:N17", "V6:V17") %>%
  setNames(mipElements)

mipAbas <- list("11", "12", "13", "03")  %>%
  setNames(mipElements)
```

Vamos agora criar uma lista para cada ano:

```{r}
matrizes2010 <- list(mipAbas, mipRanges, nomesSetores) %>%
  pmap(function(x,y,z) readxl::read_xls(path = mip2010,
                                        sheet = x,
                                        range = y,
                                        col_names = z)) %>%
  map(as.matrix)

matrizes2015 <- list(mipAbas, mipRanges, nomesSetores) %>%
  pmap(function(x,y,z) readxl::read_xls(path = mip2015,
                                        sheet = x,
                                        range = y,
                                        col_names = z)) %>%
  map(as.matrix)
```

Vamos agora tratar das Tabelas de Recursos e Usos. Nós desejamos retirar os seguintes elementos delas:

| Nome do Objeto | Descrição                                           | tipo de arquivo | aba | range   |
|----------------|-----------------------------------------------------|-----------------|-----|---------|
| `valorAd`        | Total de valor adicionado gerado em cada atividade  | tab2            | VA  | <span style="color: green;"> "B6:M6" </span>   |
| `W`              | Total de Salário gerado em cada atividade           | tab2            | VA  | <span style="color: green;"> "B8:M8" </span>   |
| `fatorL`         | Total do Fator Trabalho demandado em cada atividade | tab2            | VA  | <span style="color: green;"> "B19:M19" </span> |


Criando os parâmetros:

```{r}
truElements <- list("valorAd", "W", "fatorL")

truRange <- list("B6:M6", "B8:M8", "B19:M19") %>%
  setNames(truElements)
```

O arquivo `tbru` é um arquivo `zip` que contém vários arquivos, muito dos quais não nos interessam. Como já abordamos no tópico 5, vamos descompactar apenas os arquivos que nos interessam, que são os que contém a descrição `tab2` e são de 2010 e 2015:

```{r}
tab2_arquivos <-  tbru %>%
  unzip(list = T) %>%
  unlist %>%
  stringr::str_subset("tab2")
```

Vamos criar uma função que nos possibilite mais facilmente descompactar um arquivo do vetor `tab2_arquivos` diretamente apenas indicando o ano que queremos baixar.

```{r}
unzip_tab2 <- function(ano){
  .tab2_dir <- tempfile()
  
 .tab2_output <-  tab2_arquivos %>%
  stringr::str_subset(paste0("tab2_", ano, ".xls")) %>%
  unzip(zipfile = tbru,
        files = .,
        junkpaths = F,
        exdir = .tab2_dir)  
 return(.tab2_output)
}
```

Vamos então carregar para os dois anos em questão:

```{r}
tab2_2010 <- map(truRange, ~ read_xls(unzip_tab2("2010"),
                       sheet = "VA",
                       range = .x,
                       col_names = nomesSetores$Bn)
    ) %>%
  map(as.matrix)
  
tab2_2015 <-  map(truRange, 
                  ~ read_xls(unzip_tab2("2015"),
                    sheet = "VA",
                    range = .x,
                    col_names = nomesSetores$Bn)
    ) %>%
  map(as.matrix)
```

### Deflacionando os valores

Importante: nesse caso, os valores não estão deflacionados. Por isso precisamos deflacionar os valores. Como discutido durante o curso, existem várias formas de você fazer uma deflação de preços. Por questões de simplicidade, vamos usar aqui um deflator único. Para tanto, vamos comparar os valores correntes e do ano anterior da produção total da economia. Esse valor está disponível na célula `O19` da aba `producao` das tabelas 1 (valores correntes) e 3 (valores do ano anterior).

```{r}
tab_arquivos <- function(tab){
  .tab <- tbru %>%
    unzip(list = T) %>%
    unlist %>%
    stringr::str_subset(paste0(tab, "_", 201)) %>%
    as.list()
  return(.tab)
}

deflatorY2Y <- function(Corrente, Anterior){

  fileCor <- tempfile(fileext = ".xls")
  fileAnt <- tempfile(fileext = ".xls")

  unziptab <- function(x,y){
    unzip(zipfile = tbru,
        files = x,
        junkpaths = F,
        exdir = y,
        overwrite = T)
  }
  
  .Cor <- read_xls(path = unziptab(Corrente, fileCor),
                   sheet = "producao",
                   range = "O19",
                   col_names = "Total") %>%
    unlist()
  
  .Ant <- read_xls(path = unziptab(Anterior, fileAnt),
                   sheet = "producao",
                   range = "O19",
                   col_names = "Total") %>%
    unlist()
    
    return(.Cor/.Ant)
}

deflatores_Ano_a_Ano <- map2(tab_arquivos("tab1"),
                             tab_arquivos("tab3"),
                             deflatorY2Y)
```

Para gerar um deflator direto de 2010 a 2015, multiplicamos todos os deflatores de 2011 à 2015  (o deflator de 2010 é referente a deflação de preços de 2010 frente à 2009, por isso iremos exclui-lo), isso nos retorna a relação entre os preços de 2010 e 2015. Para tanto, vamos usar a função `purrr::reduce` do pacote purrr.

```{r}
deflator <- deflatores_Ano_a_Ano[-1] %>%
  reduce(`*`)
```

Agora, vamos deflacionar os valores que devem ser deflacionados:

```{r}
matrizes2015$f_p <- matrizes2015$f_p/deflator

tab2_2015$valorAd <- tab2_2015$valorAd/deflator
tab2_2015$W <- tab2_2015$W/deflator
```

Agora temos todos os nossos valores prontos para realizar uma decomposição.


## Análise de Decomposição Estrutural

**Atenção:** a parte a seguir vamos deixar as contas mais simples ocultas. É sugerido que se pegue um papel e caneta e faça as contas por si só.

A análise de decomposição estrutural ( _Structural Decomposition Analisys: SDA_) é uma forma de se decompor os motivos que explicam uma diferença entre dois períodos ou regiões de um determinado valor. Podemos dividir as decomposições em dois tipos: as aditivas e as multiplicativas. As aditivas são referentes as diferenças em termos absolutos, como $x_1 - x_0$, enquanto as multiplicativas são referentes as diferenças em taxa, $\frac{x_1}{x_0}$. Podemos também decompor as mudanças na Inversa de Leontief (ou em quaisquer multiplicadores similares).

**ATENÇÃO:** A notação neste tópico segue a seguinte lógica: um sobreescrito $i$ se refere ao período da variável, enquanto o subscrito $j$ é para denominar variáveis diferentes. Ou seja: $x^0_j$ e $x^1_j$ são a mesma variáveis porém de períodos/regiões diferentes. Enquanto isso, $x^i_1$ e $x^i_2$ são variáveis diferentes de um mesmo período/região. 



### Decomposições Aditivas.

Como já dito, a decomposição aditiva se preocupa com a diferença entre dois resultados em termos absolutos, ou seja $\Delta x = X^1 - X^0$. Esse caso de decomposição é a mais simples de se efetuar _a priori_, porém ela contém nuances quando tratamos de casos com mais de duas variaveis. Vamos no entanto, começar por um caso justamente com apenas duas variáveis para podermos discutir essa questão. 

Sejam $X^0$ e $X^1$ os valores bruto de produção dos períodos 0 e 1, que são dados a partir do modelo básico de Leontief:

$$X = L f$$
```{r}
matrizes2010$An <- matrizes2010$D_MS %*% matrizes2010$Bn
matrizes2010$Leontief <- solve(diag(nrow(matrizes2010$An)) - matrizes2010$An)
matrizes2010$f <- matrizes2010$D_MS %*% matrizes2010$f_p
matrizes2010$X <- matrizes2010$Leontief %*% matrizes2010$f

matrizes2015$An <- matrizes2015$D_MS %*% matrizes2015$Bn
matrizes2015$Leontief <- solve(diag(nrow(matrizes2015$An)) -     matrizes2015$An)
matrizes2015$f <- matrizes2015$D_MS %*% matrizes2015$f_p
matrizes2015$X <- matrizes2015$Leontief %*% matrizes2015$f

```

Sendo $L$ a inversa de Leontief e $f$ o vetor de demanda final. A definição de $X^0$ é $X^1$ é, respectivamente $X^0 = L^0f^0$ e $X^1 = L^1 f^1$. Desse modo, queremos agora saber qual foi a contribuição das variações tanto de $L$ quanto de $f$ para a variação final em $X$. Temos então que:

$$\Delta X = X^1 - X^0 = L^1f^1 - L^0f^0$$

```{r}
deltaX <- matrizes2015$X - matrizes2010$X
```


Seja $\Delta L = L^1 - L0$ e $\Delta f = f^1 - f^0$, podemos substituir na equação acima os valores de modo:

$$\Delta X = L^1 (f^0 + \Delta f) - (L^1 - \Delta L) f^0 = \Delta L f^0 + L^1(\Delta f)$$
```{r}
deltaL <- matrizes2015$Leontief - matrizes2010$Leontief
deltaf <- matrizes2015$f - matrizes2010$f
```

```{r}
deltaX1 <- (deltaL %*% matrizes2010$f) + (matrizes2015$Leontief %*% deltaf)

all.equal(deltaX1, deltaX)
```

Podemos no entanto, redistribuir isso de outra forma:

$$\Delta X = (L^0 + \Delta L) f^1 - L^0(f^1 -  \Delta f) = (\Delta L)f^1 + L^0 (\Delta f)$$

```{r}
deltaX2 <- (deltaL %*% matrizes2015$f) + (matrizes2010$Leontief %*% deltaf)

all.equal(deltaX2, deltaX)
```

_Relembrando:_ Para ter certeza que compreendeu a álgebra, faça essas substituições e operações no papel.

Ambas as formas apresentadas agora são igualmente válidas, sendo ambas igualmente corretas.

```{r}
all.equal(deltaX1, deltaX2)
```

 No entanto, é de certo modo óbvio que esperamos que $(\Delta L)f^1 \neq (\Delta L) f^0 $.

```{r}
all.equal(deltaL %*% matrizes2010$f,
          deltaL %*% matrizes2015$f)
```


Dietzenbacher e Los (1998), mostram que ao tirarmos os valores médios das adições aditivas temos um resultado aceitável:

$$\Delta X = (1/2) \Delta L (f^0 + f^1) + (1/2) (L^0 + L^1) \Delta f $$

```{r}
deltaX3 <- ((1/2) *deltaL %*% (matrizes2010$f + matrizes2015$f)) +
  ((1/2)*(matrizes2010$Leontief + matrizes2015$Leontief) %*% deltaf)

all.equal(deltaX, deltaX3)
```

Na equação acima, temos que a parcela $(1/2) \Delta L (f^0 + f^1)$ é referente a mudança tecnológica enquanto $(1/2) (L^0 + L^1) \Delta f$ é referente a mudanças na demanda final.

### Decomposições aditivas com mais de 2 variáveis

A decomposição anterior apresentou a forma aditiva com duas variáveis. Como vimos, há duas formas de se decompor $\Delta X = L^1f^1 - L^0f^0$. Como veremos a seguir isso se deve ao fator de que a quantidade de formas possíveis de se decompor é igual ao valor fatorial de variáveis da decomposição. Ou seja, se você tiver $n$ variáveis explicativas, de tal modo que $X = x_1 \dots x_n$, você terá $n!$ decomposições possíveis. A melhor forma de entender isso é olhando a forma abstrata da decomposição aditiva. Comecemos novamente por duas variáveis explicativas: $X = x_1 x_2$. Uma vez que temos $\Delta X = X^1 - X^0 = x_1^1x_2^1 - x_1^0x_2^0$ e que $\Delta x_1 = x_1^1 - x_1^0$ e $\Delta x_2 = x_2^1 - x_2^0$, podemos, como antes, substituir esses elementos. Como já vimos antes, temos DUAS formas de fazer essa substituição: começando por $x_1$ ou por $x_2$. Vamos primeiro começar por $x_1$. 

Fazendo $x_1^1 = \Delta x_1 + x_1^0$, temos que:

$$\Delta X = (\Delta x_1 + x_1^0) x_2^1 - x_1^0x_2^0 = \Delta x_1 x^1_2 + x^0_1x^1_2 - x^0_1x^0_2$$
Podemos então substituir $x^1_2 = \Delta x_2 + x_2^0$ em $x^0_1 x^1_2$ e teremos:

$$\Delta X = \Delta x_1 x^1_2 + x^0_1(\Delta x_2 + x^0_2) - x^0_1x^0_2 = \Delta x_1 x^1_2 + x^0_1\Delta x_2 + x^0_1x^0_2 - x^0_1x^0_2$$
Como os dois últimos elementos se cancelam, temos que:

$$\Delta X = \Delta x_1 x_2^1 + x_1^0 \Delta x_2$$

Como já falamos, o mesmo processo pode ser feito, só que começando por $x_2$. Sendo $ x_2^1 = x_2^0 + \Delta x_2$:

$$\Delta X = x_1^1 (\Delta x_2 + x^0_2) - x_1^0x_2^0 = x^1_1\Delta x_2 + x^1_1 x_2^0 - x_1^0x_2^0 $$

Substituindo $x_1^1 = \Delta x_1 + x_1^0$ temos:

$$\Delta X = x_1^1 \Delta x_2 + (\Delta x_1 + x_1^0)x_2^0 - x_1^0x_2^0 = x_1^1 \Delta x_2 + \Delta x_1x_2^0 + x_1^0x_2^0 - x_1^0x_2^0$$

Com os dois últimos elementos se cancelando temos que:

$$\Delta X = x^1_1 \Delta x_2 = \Delta_1 x^0_2$$

Para quem quiser realmente **entender** essa substituição fica a sugestão de fazer essa decomposição substituindo $x^0_1 = x^1_1 - \Delta x_1$ e $x^0_2 = x^1_2 - \Delta x_2$ e ver que os resultados não se diferenciam. Assim, como sugerido por Dietzenbacher e Los (1997) podemos simplesmente tirar a média aritmética das duas decomposições e fazer sem problema.

Por se tratar de uma decomposição com apenas 2 variáveis, a decomposição irá eventualmente começar por um dos polos da equação. Ou seja, sendo $\Delta X = x_1^1x_2^1 - x_1^0x_2^0$, vamos começar inevitavelmente a decomposição por $x_1$ ou $x_2$. Além disso, se a decomposição começa por $x_1$ ela inevitavelmente termina por $x_2$ e vice e versa. Isso é importante, pois ajuda a entender o porque que teremos sempre $n!$ decomposições possíveis para $X = x_1 \dots x_n$. Vamos agora vizualizar o caso de $X = x_1x_2x_3$.

## ggplot2

Vamos agora aproveitar os dados elavorados para a decomposição e visualizá-los aplicando o pacote `ggplot2`. Trata-se de um pacote com várias possibilidades de configurações, de forma que será impossível explorar todo o pacote, mas ao menos as principais configurações possíveis.

### Como criar gráficos no ggplot2

A ideia central é formar os gráficos por camadas, adicionando elementos sequencialmente. 

## Agradecimentos

Os autores agradecem [João Pedro Oliveira](https://github.com/kimjoaoun) por amavelmente ceder a imagem feita por ele e [Pedro Cavalcante](https://github.com/pedrocava).

## Bibliografia usada neste material

### Análise de Decomposição Estrutural

DIETZENBACHER, Erik; LAHR, Michael L.; LOS, Bart. The decline in labor compensation’s share of GDP: a structural decomposition analysis for the United States, 1982 to 1997. Wassily Leontief and Input-Output Economics, p. 138-185, 2004.

DIETZENBACHER, Erik; LOS, Bart. Structural decomposition techniques: sense and sensitivity. Economic Systems Research, v. 10, n. 4, p. 307-324, 1998.

MILLER, Ronald E.; BLAIR, Peter D. Input-output analysis: foundations and extensions. Cambridge university press, 2009.

### ggplot2

WICKHAM, Hadley. ggplot2: elegant graphics for data analysis. springer, 2016. Acesse a versão online em: https://ggplot2-book.org



## Confira também!

Outras bibliografias de artigos e sites para você acessar e aprender mais coisas de formas mais profunda.

### ggplot2

[How to make any plot in ggplot2?](http://r-statistics.co/ggplot2-Tutorial-With-R.html)

[The R Graph Gallery](https://www.r-graph-gallery.com/)
